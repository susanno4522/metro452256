"use strict";function _toConsumableArray(t){if(Array.isArray(t)){for(var e=0,s=Array(t.length);e<t.length;e++)s[e]=t[e];return s}return Array.from(t)}!function(){var t=window.Fizzmod,e=window.$,s=window.vtexid,r={MDListEntity:"LS",MDUserListsEntity:"UL",storeListId:"store",user:{},userLists:[],storeLists:[],listDataCache:{},nodeMiddleware:null,redirectOnLoginFail:!1,mustCreateListDefault:!1,mayBeContainsCustomUserId:!1,mustCreateLinkDefault:!1,mustSanitizeSkus:!1,url:{LOGIN:"/login"},init:function(){return this},_updateUsersLists:function(){var s=this,r=JSON.stringify(this.userLists),i=t.MasterData.insertUpdate(this.user.UserId,{shoppingList:r},this.MDUserListsEntity);return i.done((function(){e(window).trigger("UsersListsUpdated",s.userLists)})),i},login:function(){var t=this;if(void 0===s){var r="/"+window.location.href.split("/").splice(3).join("/");window.location.href=this.url.LOGIN+"?ReturnUrl="+r}else s.start(),e(document).on("click",".vtexIdUI-close",(function(){t.redirectOnLoginFail&&(document.referrer?window.location.href=document.referrer:window.location.href="/")}))},__setCorrectId:function(s){var r=this,i=e.Deferred();return t.MasterData.search({email:s.Email},["customUserId","email","userId"],"CL").done((function(t){var s=t.getResults();s.length>0&&s[0].customUserId&&(r.user.UserId=s[0].customUserId),r.getUserLists().done((function(t){e(window).trigger("ShoppingListReady",r.user),i.resolve(t)}))})),i.promise()},start:function(t){var s=this,r=arguments.length>1&&void 0!==arguments[1]&&arguments[1];if(this.user=t,this.redirectOnLoginFail=r,this.user&&this.user.IsUserDefined){if(this.mayBeContainsCustomUserId)return this.__setCorrectId(t);this.user=Object.assign({},this.user,{UserId:md5(this.user.Email+"-metrofood")});var i=this.getUserLists();return i.done((function(){e(window).trigger("ShoppingListReady",s.user)})),i}return this.login(),e.Deferred().promise()},setUser:function(t){return t&&t.IsUserDefined?void(this.user=t):console.log("'userData' is not defined")},setNodeMiddleware:function(t){return this.nodeMiddleware=t,this},isLoggedIn:function(){return!!this.user&&!!this.user.IsUserDefined},getListById:function(s){var r=this,i=void 0;if(Fizzmod.MasterData.setStore("wongfood"),null==this.listDataCache[s])(i=t.MasterData.get(s,["name","type","skus","listCreatedDate","createdIn","defaultList"],this.MDListEntity)).done((function(t){""!==t.getResults()&&(r.listDataCache[s]=t.getResults())}));else{var n=this.listDataCache[s],a=e.Deferred(),o={getResults:function(){return n}};a.resolve(o),i=a.promise()}return i},sanitizeSkus:function(t){if(!this.mustSanitizeSkus)return t;try{var e=Object.assign({},JSON.parse(t));if("string"==typeof e)throw new Error("JSON double stringified");if(null===e)return JSON.stringify({});for(var s in e){var r=parseInt(e[s].quantity),i=parseInt(s);delete e[s],isNaN(i)||isNaN(r)||(e[i]={quantity:r})}return JSON.stringify(e)}catch(t){throw new Error("invalid JSON")}},formatList:function(e){if(this.mustSanitizeSkus){var s=Object.assign({},e);try{s.skus=t.ShoppingList.sanitizeSkus(s.skus)}catch(t){throw new Error("error format list")}return s}return e},compareListDate:function(t,e){var s=t.listCreatedDate||t.createdIn,r=e.listCreatedDate||e.createdIn;return new Date(r)-new Date(s)},compareListIds:function(t,e){return this.listDataArray.findIndex((function(e){return e.id==t}))-this.listDataArray.findIndex((function(t){return t.id==e}))},getListArray:function(t){var s=this,r=arguments.length>1&&void 0!==arguments[1]&&arguments[1];if(!Array.isArray(t))return e.Deferred().reject(new Error("invalid listIdArray: "+t));if(r&&!this.nodeMiddleware)return e.Deferred().reject(new Error("This method requires a node middleware"));for(var i=void 0,n="",a=0;a<t.length;a++)null!==t[a]&&""!==t[a]&&(a&&(n+="&"),n+="listIds[]="+t[a]);if(r){var o=""+janisFront.BASE_URL+janisFront.GET_SHOP_LIST+"?"+n,u=e.Deferred();e.ajax({url:o,headers:janisFront.BASE_HEADERS,success:function(t){return u.resolve(t.lists)},error:u.reject}),i=u.promise()}else i=this.getShopLists(t);return i.done((function(t){for(var e=0;e<t.length;e++)s.listDataCache[t[e].id]=t[e];r||s.userLists.sort(s.compareListIds.bind(s))})),i},getShopLists:function(t){var s=this,r=t.filter((function(t){return null!==t&&""!=t})).map((function(t){return s.getListById(t)})),i=e.Deferred();return e.when.apply(e,_toConsumableArray(r)).done((function(){for(var t=arguments.length,e=Array(t),r=0;r<t;r++)e[r]=arguments[r];var n=e.map((function(t){return t.getResults()})).filter((function(t){return""!=t}));n.sort(s.compareListDate),s.listDataArray=n,i.resolve(n)})).fail((function(t){i.reject(t)})),i},getUserListArray:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:this.user.UserId;return t.MasterData.search({userId:e},["name","type","skus"],this.MDListEntity)},__createDefaultList:function(s){var r=this,i=e.Deferred();JSON.stringify(!0);var n="Mis Preferidos",a=this.user.UserId,o=JSON.stringify(!0);if(""===s){var u=this.user.UserId,l=null,d=null;t.MasterData.insert({type:"client",userId:a,name:n,defaultList:o},"LS").then((function(e){return d=e.getResults().Id.replace("LS-",""),l=JSON.stringify([d]),t.MasterData.insert({listDefaultCreated:!0,shoppingList:l,id:u},"UL")})).then((function(){r.listDefault=d,r.userLists=JSON.parse(l),i.resolve(d)}))}else if(s.listDefaultCreated)this.__getDefaultList(this.user.UserId).done((function(t){if(null===t)return i.resolve(t);r.listDefault=t.id.replace("LS-",""),Object.keys(JSON.parse(t.skus)).length>0&&r.mustCreateLinkDefault&&r.__createLinkToUserDefault(t.id),i.resolve(t)})).fail((function(t){return i.resolve()}));else{var f=s.id,c=JSON.stringify(!0),h=null;t.MasterData.insert({type:"client",userId:a,name:n,defaultList:o},"LS").then((function(e){h=e.getResults().Id.replace("LS-","");var s=JSON.stringify([].concat(_toConsumableArray(r.userLists),[h]));return r.userLists=JSON.parse(s),t.MasterData.insertUpdate(f,{listDefaultCreated:c,shoppingList:s},"UL")})).then((function(t){r.listDefault=h,i.resolve(h)}))}return i},__createLinkToUserDefault:function(t){e("#mis-preferidos-link").length||e(selector).before('<a href="/lista-de-compra?l='+t+'" id="mis-preferidos-link">Mis Preferidos</a>')},__removeLinkToUserDefault:function(){e("#mis-preferidos-link").remove()},__getDefaultList:function(s){var r=this,i=e.Deferred();return t.MasterData.search({_where:"(userId="+s+" AND defaultList=true)",_sort:"createdIn DESC"},["id","skus","name"],"LS").done((function(t){if(void 0===t.getResults()[0])i.resolve(null);else try{var e=r.formatList(t.getResults()[0]);i.resolve(e)}catch(t){i.reject("invalid list")}})).fail((function(t){i.reject(t)})),i},getUserLists:function(){Fizzmod.MasterData.setStore("wongfood");var s=this,r=arguments.length>0&&void 0!==arguments[0]?arguments[0]:this.user.UserId,i=t.MasterData.get(r,["shoppingList","listDefaultCreated"],this.MDUserListsEntity);if(console.log("r",r),this.mustCreateListDefault){var n=e.Deferred(),a=null;return i.then((function(t){return""!==t.getResults()&&null!==t.getResults().shoppingList&&(s.userLists=JSON.parse(t.getResults().shoppingList)),a=t,s.__createDefaultList(t.getResults())})).then((function(t){n.resolve(a)})),n}return i.done((function(t){""!==t.getResults()&&null!==t.getResults().shoppingList&&(s.userLists=JSON.parse(t.getResults().shoppingList))})),i},getStoreList:function(){var s=this,r=e.Deferred();return t.MasterData.get(this.storeListId,["shoppingList"],this.MDUserListsEntity).done((function(t){var e=(t=t.getResults()).shoppingList;e="string"==typeof e?JSON.parse(t.shoppingList):t.shoppingList,s.getListArray(e,!0).done((function(t){return r.resolve(t)})).fail((function(t){return r.reject(t)}))})),r},createUserList:function(t){var e=this,s=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];if(!this.isLoggedIn())return this.login();t.userId=this.user.UserId,t.type="client",t.listCreatedDate=(new Date).toISOString();var r=Fizzmod.MasterData.insert(t,this.MDListEntity);return s&&r.done((function(s){var r=null!=s.getResults().Id?s.getResults().Id:s.getResults().id,i=r.replace("LS-",""),n={id:i,name:t.name,type:"client",skus:null,createdIn:moment(moment.now()).toISOString()};Aurora.createdListFirstInModal&&Aurora.isMobile()&&(n.justCreated=!0),e.listDataCache[i]=n,e.addListToUserLists(r),$(elem.shopListAddLoader).fadeOut(timeFx,easing),$(window).trigger("userListCreated",r)})),r},updateUserList:function(s){var r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:this.listDataCache[s],i=r.id,n=r.name,a=r.skus,o=r.type,u=void 0===o?"client":o,l={id:i,name:n,skus:a,type:u},d=t.MasterData.insertUpdate(s,l,this.MDListEntity);return d.done((function(t){e(window).trigger("userListUpdated",s)})),d},removeUserList:function(t){return this.removeListFromUserLists(t)},removeUserListArray:function(t){for(var e=0;e<t.length;e++)this.userLists.splice(this.userLists.indexOf(t[e]),1);return this._updateUsersLists()},addListToUserLists:function(t){return this.userLists.unshift(t.replace(this.MDListEntity+"-","").toString()),this._updateUsersLists()},removeListFromUserLists:function(t){return this.userLists.splice(this.userLists.indexOf(t),1),this._updateUsersLists()},updateSkuData:function(t,s){if(!this.listDataCache[t])return console.log("List not found in cache");var r=this.listDataCache[t].skus?JSON.parse(this.listDataCache[t].skus):{};for(var i in s)e.isEmptyObject(s[i])?delete r[i]:r[i]=s[i];return this.listDataCache[t].skus=e.isEmptyObject(r)?null:JSON.stringify(r),this.updateUserList(t)}};t.ShoppingList=r}();