"use strict";function _toConsumableArray(r){if(Array.isArray(r)){for(var e=0,t=Array(r.length);e<r.length;e++)t[e]=r[e];return t}return Array.from(r)}function _defineProperty(r,e,t){return e in r?Object.defineProperty(r,e,{value:t,enumerable:!0,configurable:!0,writable:!0}):r[e]=t,r}var _slicedToArray=function(r,e){if(Array.isArray(r))return r;if(Symbol.iterator in Object(r))return function(r,e){var t=[],o=!0,a=!1,n=void 0;try{for(var c,s=r[Symbol.iterator]();!(o=(c=s.next()).done)&&(t.push(c.value),!e||t.length!==e);o=!0);}catch(r){a=!0,n=r}finally{try{!o&&s.return&&s.return()}finally{if(a)throw n}}return t}(r,e);throw new TypeError("Invalid attempt to destructure non-iterable instance")},_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(r){return typeof r}:function(r){return r&&"function"==typeof Symbol&&r.constructor===Symbol&&r!==Symbol.prototype?"symbol":typeof r};!function(r,e,t,o,a){var n=void 0,c={varsionCache:"1.0",maxParamsPerRequest:50,productCache:{},productCacheTemporal:{},skusProductIds:{},skusProductIdsTemporal:{},emptyFetchedParams:[],pendingParamsToFetch:[],fetchedParams:[],pendingFetchArray:[],events:{},errors:{searchParamsNotDefined:"Search parameters is not defined",paramsNotAnObject:"Param is not a valid Object",productIdNotDefined:"Product ID is not defined",skuIdNotDefined:"Sku ID is not defined",productIdArrayNotAnArray:"'productIdArray' is not an array",skuIdArrayNotAnArray:"'skuIdArray' is not an array",productIdArrayNotDefined:"'productIdArray' is not an defined",skuIdArrayNotDefined:"'skuIdArray' is not an defined",fqPropertyNotFound:"The property 'fq' was not found"},trigger:function(e,o){r(t).trigger(e,o)},error:function(r,e){console.log(n.errors[r]),e&&console.log("Data:",e)},init:function(){var r=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},e=r.sc,t=void 0===e?1:e;return(n=this).sc=t,n._updateCache(),this},_updateCache:function(){if(o.get("varsionCache")!==n.version){o.remove("productCache"),o.remove("skusProductIds");var r=(new Date).getTime()+36e5;o.set("varsionCache",n.varsionCache,r)}n.productCache=Object.assign(_defineProperty({},n.sc,{}),o.get("productCache")),n.skusProductIds=Object.assign(_defineProperty({},n.sc,{}),o.get("skusProductIds")),n.productCacheTemporal=Object.assign(_defineProperty({},n.sc,{}),n.productCacheTemporal),n.skusProductIdsTemporal=Object.assign(_defineProperty({},n.sc,{}),n.skusProductIdsTemporal)},_storeInCache:function(r,e){var t=e||n.sc,o=Object.assign({},r),a=o.productId,c=o.items;o.items=c.map((function(r){var e=Object.assign({},r),t=Object.assign({},n.getDefaultSeller(r)),o=Object.assign({},t.commertialOffer);return delete o.CacheVersionUsedToCallCheckout,delete o.Installments,delete o.GiftSkuIds,delete o.GetInfoErrorMessage,t.commertialOffer=o,e.sellers=[t],e})),Object.keys(o).forEach((function(r){-1===["ProductData","SkuData","brand","categories","categoriesIds","categoryId","clusterHighlights","description","items","link","linkText","productId","productName","productReference","Nota Pesables"].indexOf(r)&&delete o[r]})),o.description.length>300&&(o.description=o.description.slice(0,300)),n.productCache=Object.assign({},n.productCache),n.skusProductIds=Object.assign({},n.skusProductIds),n.productCache[t]||(n.productCache[t]={}),n.skusProductIds[t]||(n.skusProductIds[t]={}),n.productCache[t][a]=o,c.forEach((function(r){var e=r.itemId;n.skusProductIds[t][e]=a})),n.expiration=(new Date).getTime()+36e5},_setStore:function(){var r=decodeURI(Fizzmod.Utils.getCookie("VTEXSC")).replace("sc=",""),e={};e[r]=n.productCache[r];var t={};t[r]=n.skusProductIds[r];try{o.set("productCache",e,self.expiration),o.set("skusProductIds",t,self.expiration)}catch(r){console.log("Error de LocalStorage",r)}},_storeInCacheTemporal:function(r,e){var t=e||n.sc,o=r.productId,a=r.items;n.productCacheTemporal[t]||(n.productCacheTemporal[t]={}),n.skusProductIdsTemporal[t]||(n.skusProductIdsTemporal[t]={}),n.productCacheTemporal[t][o]=r,a.forEach((function(r){var e=r.itemId;n.skusProductIdsTemporal[t][e]=o}))},getProductCache:function(r,e){var t=e||n.sc,o=!!n.productCacheTemporal[t]&&n.productCacheTemporal[t][r],a=!!n.productCache[t]&&n.productCache[t][r];return o||a},getProductCacheBySku:function(r,e){return n.getProductCache(n.getSkuCache(r))},hasCache:function(r,e){var t=e||n.sc,o=n.productCacheTemporal[t]&&n.productCacheTemporal[t][r],a=n.productCache[t]&&n.productCache[t][r];return o||a},getSkuCache:function(r,e){var t=e||n.sc,o=!!n.skusProductIdsTemporal[t]&&n.skusProductIdsTemporal[t][r],a=!!n.skusProductIds[t]&&n.skusProductIds[t][r];return o||a},hasCacheSku:function(r,e){var t=e||n.sc,o=n.skusProductIdsTemporal[t]&&n.skusProductIdsTemporal[t][r],a=n.skusProductIds[t]&&n.skusProductIds[t][r];return o||a},_ajaxSearch:function(e,t){var o=r.Deferred();return r.ajax({url:"/api/catalog_system/pub/products/search/",data:r.param(e,!0),tryCount:0,retryLimit:3,beforeSend:function(r){for(var e in t)r.setRequestHeader(e,t[e])},success:function(r){o.resolve(r)},error:function(){++n.tryCount<=n.retryLimit?r.ajax(this):o.resolve()}}),o},search:function(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1],o=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};if(!e)return n.error("searchParamsNotDefined");if("object"!=(void 0===e?"undefined":_typeof(e)))return n.error("paramsNotAnObject");if(!e.fq)return n.error("fqPropertyNotFound");if(e.sc=void 0===e.sc?n.sc:e.sc,0===Object.keys(n.skusProductIds).length&&n._updateCache(),t){var c=function(){var t=r.extend({},e),c=[];for(var s in e)"map"!==s&&"sc"!==s&&(t[s]=e[s].filter((function(r){var t=r.split(":"),o=_slicedToArray(t,2),a=o[0],s=o[1];if("skuId"===a){if(n.skusProductIdsTemporal[e.sc]&&n.skusProductIdsTemporal[e.sc][s]){var u=n.skusProductIdsTemporal[e.sc][s];return c.push(n.productCacheTemporal[e.sc][u]),!1}}else if("productId"===a&&n.productCacheTemporal[e.sc]&&n.productCacheTemporal[e.sc][s])return c.push(n.productCacheTemporal[e.sc][s]),!1;return!0})));var u=t.fq;delete t.fq,Object.assign(t,{_from:0,_to:49});var d=a.chunk(u,50).map((function(r){return Object.assign(t,{fq:r}),n._ajaxSearch(t,o)})),i=r.Deferred();return r.when.apply(r,_toConsumableArray(d)).done((function(){for(var r=arguments.length,t=Array(r),o=0;o<r;o++)t[o]=arguments[o];t.forEach((function(r,t){var o=r;o&&(o.forEach((function(r){return n._storeInCache(r,e.sc)})),o.forEach((function(r){return n._storeInCacheTemporal(r,e.sc)}))),c=c.concat(o)})),c.length?i.resolve(c):i.reject("No products found")})).fail((function(){return i.resolve()})),n._setStore(),{v:i.promise()}}();if("object"===(void 0===c?"undefined":_typeof(c)))return c.v}else{var s=function(){var t=r.extend({},e),c=r.extend({},e),s=[];for(var u in e)!function(r){if("map"===r||"sc"===r)return"continue";c[r]=e[r].filter((function(o){var a=o.split(":"),c=_slicedToArray(a,2),s=c[0],u=c[1];if("skuId"===s){if(n.skusProductIds[e.sc][u])return!1}else if("productId"===s&&n.productCache[e.sc][u])return!1;if(~n.emptyFetchedParams.indexOf(o)){var d=t[r].indexOf(o);return t[r].splice(d,1),!1}return!~n.fetchedParams.indexOf(o)&&!~n.pendingParamsToFetch.indexOf(o)&&(n.pendingParamsToFetch.push(o),!0)}))}(u);var d=1;Array.isArray(e.fq)&&(d=c.fq.length);var i=Math.ceil(d/n.maxParamsPerRequest);if(Array.isArray(e.fq)&&e.fq.every((function(r){return r.includes("skuId")||r.includes("productId")}))){var f=c.fq;delete c.fq,Object.assign(c,{_from:0,_to:49});var p=a.chunk(f,50).map((function(r){return Object.assign(c,{fq:r}),n._ajaxSearch(c,o)}));n.pendingFetchArray=n.pendingFetchArray.concat(p)}else for(var l=0;l<i;l++){var h=l*n.maxParamsPerRequest,m=(l+1)*n.maxParamsPerRequest-1;r.extend(c,{_from:h,_to:m});var v=n._ajaxSearch(c,o);n.pendingFetchArray.push(v)}var y=r.Deferred();return r.when.apply(r,_toConsumableArray(n.pendingFetchArray)).done((function(){for(var r=arguments.length,o=Array(r),a=0;a<r;a++)o[a]=arguments[a];for(var c in o.forEach((function(r,t){r&&r.forEach((function(r){return n._storeInCache(r,e.sc)})),n.pendingFetchArray.splice(t,1)})),t)"sc"!==c&&e[c].forEach((function(r){var t=r.split(":"),o=_slicedToArray(t,2),a=o[0],c=o[1],u=void 0;switch(n.fetchedParams.push(r),a){case"skuId":var d=n.skusProductIds[e.sc][c];u=n.productCache[e.sc][d];break;case"productId":u=n.productCache[e.sc][c]}u?s.push(u):~n.emptyFetchedParams.indexOf(r)||n.emptyFetchedParams.push(r)}));if(s.length)y.resolve(s);else{var u="No products found, this are some of the querys that failed: "+n.emptyFetchedParams.toString();y.reject(u)}})).fail((function(r){console.error("$.when(...self.pendingFetchArray) error",r),y.resolve()})),n._setStore(),{v:y.promise()}}();if("object"===(void 0===s?"undefined":_typeof(s)))return s.v}},searchProduct:function(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];if(!e)return n.error("productIdNotDefined");var o=r.Deferred();if(n.productCache[n.sc][e]&&!t)o.resolve(n.productCache[n.sc][e]);else{var a={fq:["productId:"+e]};n.search(a,t).done((function(r){return o.resolve(r[0])}))}return o.promise()},searchSku:function(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];if(!e)return n.error("skuIdNotDefined");var o=r.Deferred();if(n.skusProductIds[n.sc][e]&&!t)o.resolve(n.productCache[n.sc][n.skusProductIds[n.sc][e]]);else{var a={fq:["skuId:"+e]};n.search(a,t).done((function(r){return o.resolve(r[0])}))}return o.promise()},searchProductArray:function(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];if(!e)return n.error("productIdArrayNotDefined");if(!Array.isArray(e))return n.error("productIdArrayNotAnArray");for(var o=r.Deferred(),a={},c={fq:[]},s=0;s<e.length;s++)null==n.productCache[n.sc][e[s]]||t?c.fq.push("productId:"+e[s]):a[e[s]]=n.productCache[n.sc][e[s]];return c.fq.length?n.search(c,t).done((function(r){for(var e=0;e<r.length;e++)a[r[e].productId]=r[e];o.resolve(a)})).fail((function(r){return o.resolve(a)})):o.resolve(a),o.promise()},searchSkuArray:function(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];if(!e)return n.error("skuIdArrayNotDefined");if(!Array.isArray(e))return n.error("skuIdArrayNotAnArray");var o=r.Deferred(),a={},c={fq:[]},s=!0,u=!1,d=void 0;try{for(var i,f=e[Symbol.iterator]();!(s=(i=f.next()).done);s=!0){var p=i.value;if(!n.skusProductIds[n.sc][p]||t)c.fq.push("skuId:"+p);else{var l=n.skusProductIds[n.sc][p];a[l]=n.productCache[n.sc][l]}}}catch(r){u=!0,d=r}finally{try{!s&&f.return&&f.return()}finally{if(u)throw d}}return c.fq.length?n.search(c,t).done((function(r){var e=!0,t=!1,n=void 0;try{for(var c,s=r[Symbol.iterator]();!(e=(c=s.next()).done);e=!0){var u=c.value;a[u.productId]=u}}catch(r){t=!0,n=r}finally{try{!e&&s.return&&s.return()}finally{if(t)throw n}}o.resolve(a)})).fail((function(r){return o.resolve(a)})):o.resolve(a),o.promise()},searchCategory:function(e){var t=this;if(!e)return n.error("searchParamsNotDefined");if("object"!=(void 0===e?"undefined":_typeof(e)))return n.error("paramsNotAnObject");if(!e.fq)return n.error("fqPropertyNotFound");for(var o={map:[]},a=0;a<e.fq.length;a++){var c=e.fq[a];if(c.match("C:"))for(var s=c.split("/"),u=0;u<s.length;u++)s[u].match(/\d.+/gi)&&o.map.push("c");c.match(/P\[.+[\d\w\s]?\]/g)&&o.map.push("priceFrom")}o.map=o.map.join(","),r.extend(e,o,{_from:0,_to:49});var d=r.ajax({url:"/api/catalog_system/pub/products/search/",data:r.param(e,!0)});return d.done((function(r){return r.forEach(n._storeInCache.bind(t))})),d},searchCollection:function(e,t){var o=this;if(!e)return n.error("searchParamsNotDefined");if("object"!=(void 0===e?"undefined":_typeof(e)))return n.error("paramsNotAnObject");if(!e.fq)return n.error("fqPropertyNotFound");r.extend(e,{_from:0,_to:49});var a=r.ajax({url:"/api/catalog_system/pub/products/search/",data:r.param(e,!0),beforeSend:function(r){for(var e in t)r.setRequestHeader(e,t[e])}});return a.done((function(r){return r.forEach(n._storeInCache.bind(o))})),a},getDefaultSeller:function(r){return r.sellers.find((function(r){return r.sellerDefault}))}};e.Catalog=c,c.init()}(jQuery,Fizzmod,window,store,lodash);